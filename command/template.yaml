title: Command Server
name: command
use_python: true
expose: true
port: 7000

prepare_env: "pip install -r requirements.txt"

start: |-
  /usr/bin/supervisorctl -c $WORKING_DIR/supervisord.conf restart {{ name }}
  if [[ -n "${DISCORD_BOT}" ]]; then
    /usr/bin/supervisorctl -c $WORKING_DIR/supervisord.conf restart command_process
  fi
  cd ..

export_required_env: |-
  export REQUIRED_ENV="COMMAND_USERNAME,COMMAND_PASSWORD"

other_commands: |-
  export {{ name|upper }}_PORT="{{ port }}"
  export EXPOSE_PORTS="$EXPOSE_PORTS:${{ name|upper }}_PORT"
  export PORT_MAPPING="$PORT_MAPPING:{{ name }}"

custom_stop: |-
  /usr/bin/supervisorctl -c $WORKING_DIR/supervisord.conf stop {{ name }}
  if [[ -n "${DISCORD_BOT}" ]]; then
    /usr/bin/supervisorctl -c $WORKING_DIR/supervisord.conf stop command_process
  fi

supervisord: |-
  [program:{{ name }}]
  command={{ venv_dir }}/{{ name }}-env/bin/python -m uvicorn main:app --host 0.0.0.0 --port {{ port }}
  directory=./{{ name }}/server
  autostart=false
  autorestart=true
  stdout_logfile={{ log_dir }}/{{ name }}.log
  redirect_stderr=true
  environment=PYTHONUNBUFFERED=1

  [program:command_process]
  command={{ venv_dir }}/{{ name }}-env/bin/python process.py
  directory=./{{ name }}/server
  autostart=false
  autorestart=true
  stdout_logfile={{ log_dir }}/{{ name }}_process.log
  redirect_stderr=true
  environment=PYTHONUNBUFFERED=1