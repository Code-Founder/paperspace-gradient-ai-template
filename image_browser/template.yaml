title: Image Browser
name: image_browser
use_python: true
expose: true
port: 7002

prepare_repo: |-
  TARGET_REPO_URL="https://github.com/zanllp/sd-webui-infinite-image-browsing.git" \
  TARGET_REPO_DIR=$REPO_DIR \
  UPDATE_REPO="auto" \
  TARGET_REPO_BRANCH="main" \
  bash $current_dir/../utils/prepare_repo.sh

prepare_env: |-
  cd $REPO_DIR
  pip install -r requirements.txt

action_before_start: |-
  if [[ -n "${IMAGE_BROWSER_KEY}" ]]; then
  cat > $REPO_DIR/.env << EOF
  IIB_SECRET_KEY=$IMAGE_BROWSER_KEY
  # Configuring the server-side language for this extension,
  # including the tab title and most of the server-side error messages returned. Options are 'zh', 'en', or 'auto'.
  # If you want to configure the language for the front-end pages, please set it on the extension's global settings page.
  IIB_SERVER_LANG=auto
  EOF
  fi

start: |-
  /usr/bin/supervisorctl -c $WORKING_DIR/supervisord.conf restart {{ name }}

export_required_env: |-
  export REQUIRED_ENV=""

other_commands: |-
  export REPO_DIR=${{ '{' ~ name|upper }}_REPO_DIR:-"$ROOT_REPO_DIR/sd-webui-infinite-image-browsing"}
  export {{ name|upper }}_PORT="{{ port }}"
  export EXPOSE_PORTS="$EXPOSE_PORTS:${{ name|upper }}_PORT"
  export PORT_MAPPING="$PORT_MAPPING:{{ name }}"

nginx_override: |-
  absolute_redirect off;
  return 301 /infinite_image_browsing;

supervisord: |-
  [program:{{ name }}]
  command={{ venv_dir }}/{{ name }}-env/bin/python {{ root_repo_dir }}/sd-webui-infinite-image-browsing/app.py --port="{{ port }}"
  directory={{ image_outputs_dir }}
  autostart=false
  autorestart=true
  stdout_logfile={{ log_dir }}/{{ name }}.log
  redirect_stderr=true
  environment=PYTHONUNBUFFERED=1